import React from 'react';
import { format } from 'date-fns';
import { ru } from 'date-fns/locale';
import { Check, CheckCheck } from 'lucide-react';
import clsx from 'clsx';

const MessageBubble = ({ message, isOwn, currentUser }) => {
  const formatTime = (timestamp) => {
    try {
      const date = new Date(timestamp);
      return format(date, 'HH:mm', { locale: ru });
    } catch (error) {
      return '';
    }
  };

  const getStatusIcon = (status) => {
    switch (status) {
      case 'sending':
        return <div className="w-4 h-4 border-2 border-telegram-secondary border-t-transparent rounded-full animate-spin" />;
      case 'sent':
        return <Check className="w-4 h-4 text-telegram-secondary" />;
      case 'delivered':
        return <CheckCheck className="w-4 h-4 text-telegram-secondary" />;
      case 'read':
        return <CheckCheck className="w-4 h-4 text-blue-500" />;
      default:
        return null;
    }
  };

  const getSenderName = () => {
    if (isOwn) return '–í—ã';
    return message.from?.first_name || message.from?.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
  };

  const getMessageContent = () => {
    switch (message.type) {
      case 'text':
        return (
          <div className="whitespace-pre-wrap break-words">
            {message.text}
          </div>
        );
      case 'file':
        return (
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-telegram-secondary rounded flex items-center justify-center">
              üìé
            </div>
            <span>–§–∞–π–ª</span>
          </div>
        );
      case 'voice':
        return (
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-telegram-secondary rounded flex items-center justify-center">
              üé§
            </div>
            <span>–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
          </div>
        );
      case 'photo':
        return (
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-telegram-secondary rounded flex items-center justify-center">
              üì∑
            </div>
            <span>–§–æ—Ç–æ</span>
          </div>
        );
      default:
        return <div>{message.text}</div>;
    }
  };

  return (
    <div className={clsx(
      'flex',
      isOwn ? 'justify-end' : 'justify-start'
    )}>
      <div className={clsx(
        'max-w-xs lg:max-w-md',
        isOwn ? 'order-2' : 'order-1'
      )}>
        {/* –ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö) */}
        {!isOwn && message.chat?.type === 'group' && (
          <div className="text-xs text-telegram-text-secondary mb-1 ml-1">
            {getSenderName()}
          </div>
        )}

        {/* –ü—É–∑—ã—Ä–µ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è */}
        <div className={clsx(
          'message-bubble',
          isOwn ? 'outgoing' : 'incoming'
        )}>
          {getMessageContent()}
        </div>

        {/* –í—Ä–µ–º—è –∏ —Å—Ç–∞—Ç—É—Å */}
        <div className={clsx(
          'flex items-center mt-1 space-x-1',
          isOwn ? 'justify-end' : 'justify-start'
        )}>
          <span className="text-xs text-telegram-text-secondary">
            {formatTime(message.timestamp)}
          </span>
          
          {isOwn && (
            <div className="flex items-center">
              {getStatusIcon(message.status)}
            </div>
          )}
        </div>
      </div>

      {/* –ê–≤–∞—Ç–∞—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π) */}
      {!isOwn && (
        <div className={clsx(
          'w-8 h-8 rounded-full bg-gradient-to-br from-telegram-primary to-blue-600 flex items-center justify-center text-white text-sm font-medium ml-2 order-2 flex-shrink-0 shadow-sm',
          'self-end mb-1'
        )}>
          {message.from?.first_name?.charAt(0).toUpperCase() || '?'}
        </div>
      )}
    </div>
  );
};

export default MessageBubble;
